<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopper's Footprint</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #212529;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --border-color: #dee2e6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --danger-color: #dc3545;
            --danger-light: #f8d7da;
            --success-color: #28a745;
            --success-light: #d4edda;
            --ai-color: #6f42c1;
            --ai-light: #e9d8fd;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .phone-screen {
            display: flex;
            flex-direction: column;
            width: 375px;
            height: 812px;
            border: 12px solid #111;
            border-radius: 40px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            background: #f8f9fa;
        }

        .phone-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .phone-content::-webkit-scrollbar { display: none; }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        h1, h2 { text-align: center; margin-top: 0; font-weight: 700; }
        h1 { color: var(--primary-color); font-size: 24px; }
        h2 { font-size: 20px; margin-bottom: 20px; }
        
        /* Summary Card Styling */
        .summary-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .stat-item {
            flex-basis: 50%;
        }
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }

        .dashboard {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 15px;
            min-height: 150px;
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            gap: 10px;
        }
        .package-box {
            position: relative; background-color: #f0ead6; border: 2px solid #d4cba7;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;
            border-radius: 4px;
        }
        .package-box:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        #purchase-form { display: grid; gap: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 16px; font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        button[type="submit"] {
            background-color: var(--primary-color); color: white; border: none;
            padding: 15px; border-radius: 8px; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: background-color 0.2s;
        }
        button[type="submit"]:hover { background-color: var(--primary-hover); }

        /* AI Feature Styling */
        .ai-card { border-left: 4px solid var(--ai-color); }
        .file-upload-wrapper {
            border: 2px dashed var(--ai-color); border-radius: 8px; padding: 20px;
            text-align: center; cursor: pointer; background-color: var(--ai-light);
            transition: background-color 0.2s;
        }
        .file-upload-wrapper:hover { background-color: #d9c4f7; }
        .file-upload-wrapper input[type="file"] { display: none; }
        .ai-label { font-weight: 600; color: var(--ai-color); }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--ai-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 10px auto 0;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .message {
            text-align: center; padding: 12px; border-radius: 8px; font-weight: 500;
        }
        .message.success { background-color: var(--success-light); color: #155724; }
        .message.error { background-color: var(--danger-light); color: #721c24; }

        /* Modal Styling */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 320px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 28px;
            line-height: 1;
            color: #888;
            cursor: pointer;
        }
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-align: left;
        }
        .modal-content p {
            margin: 10px 0;
            line-height: 1.6;
        }
        .modal-content p strong {
            color: var(--text-color);
        }
    </style>
</head>
<body>

    <div id="app">
        <main class="phone-screen">
            <div class="phone-content">
                <div class="card">
                    <h1>Shopper's Footprint</h1>
                </div>

                <div class="card">
                    <h2>Summary</h2>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-value">{{ totalPackages }}</div>
                            <div class="stat-label">Packages</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ totalCarbonFootprint }}</div>
                            <div class="stat-label">kg CO2e</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Your Package Pile</h2>
                    <div class="dashboard">
                        <div v-for="purchase in purchases" :key="purchase.id"
                             class="package-box"
                             :style="getBoxStyle(purchase)"
                             @click="openModal(purchase)">
                        </div>
                    </div>
                </div>

                <div class="card ai-card">
                    <h2>Log with AI âœ¨</h2>
                    <div class="file-upload-wrapper" @click="triggerFileUpload">
                        <input type="file" ref="fileInput" @change="handleImageUpload" accept="image/*">
                        <p class="ai-label">Upload a photo of your item</p>
                        <small>The AI will identify it and estimate its carbon footprint.</small>
                    </div>
                    <div v-if="isLoadingAI" class="loader"></div>
                </div>

                <div class="card">
                    <h2>Or Log Manually</h2>
                    <form id="purchase-form" @submit.prevent="handleFormSubmit">
                        <div class="form-group">
                            <label for="item-name">Item Description</label>
                            <input type="text" id="item-name" placeholder="e.g., Black T-Shirt" required v-model="newItem.name">
                        </div>
                        <div class="form-group">
                            <label for="carbon-footprint">Est. Carbon Footprint (kg CO2e)</label>
                            <input type="number" step="0.1" id="carbon-footprint" placeholder="e.g., 5.5" v-model.number="newItem.carbon_footprint">
                        </div>
                        <div class="form-group">
                            <label for="package-size">Package Size (for fallback)</label>
                            <select id="package-size" required v-model="newItem.size">
                                <option value="small">Small (Mailer)</option>
                                <option value="medium">Medium (Shoe Box)</option>
                                <option value="large">Large (Carton)</option>
                            </select>
                        </div>
                        <button type="submit">Log My Purchase</button>
                    </form>
                    <div v-if="message.visible" :class="['message', message.type]">
                        {{ message.text }}
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal for Purchase Details -->
        <div v-if="isModalVisible" class="modal-backdrop" @click="closeModal">
            <div class="modal-content" @click.stop>
                <button class="modal-close-btn" @click="closeModal">&times;</button>
                <div v-if="selectedPurchase">
                    <h3>Purchase Details</h3>
                    <p><strong>Item:</strong> {{ selectedPurchase.item_name }}</p>
                    <p><strong>Carbon Footprint:</strong> {{ selectedPurchase.carbon_footprint ? selectedPurchase.carbon_footprint + ' kg CO2e' : 'N/A' }}</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    purchases: [],
                    newItem: { name: '', size: 'small', carbon_footprint: null },
                    message: { text: '', type: '', visible: false },
                    isLoadingAI: false,
                    API_URL: 'http://127.0.0.1:5000',
                    isModalVisible: false,
                    selectedPurchase: null
                }
            },
            computed: {
                totalPackages() {
                    return this.purchases.length;
                },
                totalCarbonFootprint() {
                    const total = this.purchases.reduce((sum, item) => {
                        // Add to sum only if carbon_footprint is a valid number
                        return sum + (Number(item.carbon_footprint) || 0);
                    }, 0);
                    return total.toFixed(1); // Return total with one decimal place
                }
            },
            methods: {
                getBoxStyle(purchase) {
                    const baseSize = 30; // min size in px
                    const scaleFactor = 4; // px per kg CO2e
                    let size = baseSize;

                    if (purchase.carbon_footprint && Number(purchase.carbon_footprint) > 0) {
                        size += purchase.carbon_footprint * scaleFactor;
                    } else {
                        // Fallback to package size string if carbon footprint is not available
                        const sizeMap = { small: 35, medium: 50, large: 65 };
                        size = sizeMap[purchase.package_size] || baseSize;
                    }
                    
                    // Cap the max size to prevent overly large boxes
                    const finalSize = Math.min(size, 100); 

                    return {
                        width: `${finalSize}px`,
                        height: `${finalSize}px`,
                    };
                },
                showMessage(text, type) {
                    this.message = { text, type, visible: true };
                    setTimeout(() => { this.message.visible = false; }, 4000);
                },
                triggerFileUpload() {
                    this.$refs.fileInput.click();
                },
                async handleImageUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    this.isLoadingAI = true;
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const response = await fetch(`${this.API_URL}/analyze-image`, {
                            method: 'POST',
                            body: formData,
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => null);
                            const errorMessage = errorData?.error || `AI analysis failed with status: ${response.status}`;
                            throw new Error(errorMessage);
                        }
                        
                        const result = await response.json();
                        this.newItem.name = result.object_name;
                        this.newItem.carbon_footprint = parseFloat(result.carbon_footprint);
                        this.showMessage('AI analysis complete! Form is pre-filled.', 'success');

                    } catch (error) {
                        console.error('Error analyzing image:', error);
                        this.showMessage(error.message, 'error');
                    } finally {
                        this.isLoadingAI = false;
                        event.target.value = null; 
                    }
                },
                async fetchAndDisplayPurchases() {
                    try {
                        const response = await fetch(`${this.API_URL}/purchases`);
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        this.purchases = await response.json();
                    } catch (error) {
                        console.error('Error fetching purchases:', error);
                        this.showMessage('Could not connect to the backend.', 'error');
                    }
                },
                async handleFormSubmit() {
                    const purchaseData = {
                        item_name: this.newItem.name,
                        package_size: this.newItem.size,
                        carbon_footprint: this.newItem.carbon_footprint
                    };

                    try {
                        const response = await fetch(`${this.API_URL}/purchases`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(purchaseData),
                        });
                        if (!response.ok) throw new Error('Failed to log purchase.');
                        
                        this.newItem = { name: '', size: 'small', carbon_footprint: null };
                        this.showMessage('Purchase logged successfully!', 'success');
                        await this.fetchAndDisplayPurchases();

                    } catch (error) {
                        console.error('Error adding purchase:', error);
                        this.showMessage(error.message, 'error');
                    }
                },
                openModal(purchase) {
                    this.selectedPurchase = purchase;
                    this.isModalVisible = true;
                },
                closeModal() {
                    this.isModalVisible = false;
                    setTimeout(() => {
                        this.selectedPurchase = null;
                    }, 300);
                }
            },
            mounted() {
                this.fetchAndDisplayPurchases();
            }
        }).mount('#app');
    </script>
</body>
</html>

